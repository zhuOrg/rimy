# .github/workflows/main.yaml
name: CI Workflow

on: [push]

jobs:
  rspec-job:
    runs-on: ubuntu-latest
    container:
      image: zulhfreelancer/ruby_nodejs:latest
      env:
        # Docs: https://www.postgresql.org/docs/11/libpq-envars.html
        PGHOST: localhost
        PGUSER: postgres
        PGPASSWORD: postgres
        RAILS_ENV: test
        WORKSPACE: ${{$GITHUB_WORKSPACE}}
        WORKSPACE2: ${{GITHUB_WORKSPACE}}
        # VENDOR_PATH: ${{join(env.GITHUB_WORKSPACE, 'vendor/bundle')}}
      volumes:
        - vendor/bundle:vendor/bundle
    steps:
      - uses: actions/checkout@v2
      - name: Start database
        run: service postgresql start
      - name: Check dependency versions
        run: ruby -v && node -v && bundler -v && psql -V
      - name: Print working directory and files
        run: pwd && ls -la
      - name: Print environment variables
        run: echo $HOME && echo $GITHUB_WORKSPACE && echo $WORKSPACE && echo $WORKSPACE2 && echo $VENDOR_PATH
      # - name: Wait for database
      #   run: pg_isready -d "postgresql://postgres:postgres@localhost:5432"
      # - uses: actions/cache@v1
      #   with:
      #     path: vendor/bundle
      #     key: ${{ runner.os }}-gem-${{ hashFiles('**/Gemfile.lock') }}
      #     restore-keys: |
      #       ${{ runner.os }}-gem-
      # - name: Build & create DB
      #   run: |
      #     bundle config path vendor/bundle
      #     bundle install --jobs 4 --retry 3
      #     bin/rails db:setup
